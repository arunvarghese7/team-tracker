<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Command | Team Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              executive: {
                950: '#050507', 
                900: '#0f0f13', 
                800: '#27272a',
                700: '#3f3f46', 
                gold: '#FFC300',
                goldDim: '#B38F00',
              }
            }
          }
        }
      }
    </script>

    <style>
      body {
        background-color: #050507;
        color: #e4e4e7;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #0f0f13; }
      ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
      
      .glass-panel {
        background: rgba(15, 15, 19, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      
      /* Glowing Pulse Animation for the new card */
      @keyframes pulse-violet {
        0%, 100% { box-shadow: 0 0 15px rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); }
        50% { box-shadow: 0 0 25px rgba(139, 92, 246, 0.25); border-color: rgba(139, 92, 246, 0.6); }
      }
      .glow-card {
        animation: pulse-violet 3s infinite;
      }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <nav class="glass-panel sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-2 h-8 bg-executive-gold rounded-full"></div>
                <h1 class="text-xl font-bold tracking-tight text-white">COMMAND <span class="text-zinc-500 font-light">CENTER</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="lastUpdate" class="text-xs text-zinc-500 font-mono">Synced: --:--</span>
                <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-executive-900 border border-white/5 rounded-lg text-sm font-medium hover:bg-white/5 transition-all text-zinc-400">
                    <i data-lucide="rotate-cw" class="w-4 h-4" id="refreshIcon"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto px-6 py-10 w-full space-y-10">

        <div class="flex flex-col md:flex-row justify-between items-end gap-6 border-b border-white/5 pb-10">
            <div>
                <h2 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight mb-2">Team Performance</h2>
                <p class="text-zinc-400">Real-time operational intelligence and metric tracking.</p>
            </div>
            
            <div class="bg-executive-900 p-1 rounded-lg border border-white/10 flex">
                <button id="trackerToggle" onclick="dashboard.switchDataSource('tracker')" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-zinc-400 hover:text-white">
                    Team Tracker
                </button>
                <button id="freshserviceToggle" onclick="dashboard.switchDataSource('freshservice')" class="px-6 py-2 rounded-md text-sm font-medium transition-all text-zinc-400 hover:text-white">
                    Freshservice
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Timeframe</label>
                <div class="flex flex-col gap-2">
                    <input type="date" id="startDate" class="bg-executive-900 border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-executive-gold focus:ring-1 focus:ring-executive-gold transition-colors">
                    <input type="date" id="endDate" class="bg-executive-900 border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-executive-gold focus:ring-1 focus:ring-executive-gold transition-colors">
                    <div class="flex justify-between mt-2">
                        <button onclick="dashboard.clearAllFilters()" class="text-xs text-zinc-500 hover:text-white underline decoration-dotted">Clear Filters</button>
                        <button id="exportBtn" class="text-xs text-executive-gold hover:text-executive-goldDim font-medium flex items-center gap-1">
                            <i data-lucide="download" class="w-3 h-3"></i> CSV
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label id="engineerFilterLabel" class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Personnel</label>
                        <span class="text-[10px] text-zinc-600 bg-executive-900 px-2 py-0.5 rounded border border-white/5">Multi-select</span>
                    </div>
                    <div id="engineerFilters" class="flex flex-wrap gap-2 min-h-[40px] max-h-32 overflow-y-auto pr-2 custom-scrollbar">
                        <span class="text-zinc-600 text-sm italic py-2">Loading personnel...</span>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-2 block">Status</label>
                    <div id="statusFilters" class="flex flex-wrap gap-2">
                        </div>
                </div>
            </div>
        </div>

        <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-executive-900 border border-white/5 rounded-xl p-6 shadow-lg lg:col-span-1 flex flex-col">
                <h3 class="text-lg font-bold text-white mb-6">Performance Distribution</h3>
                <div class="relative h-64 w-full">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="mt-4 text-xs text-zinc-500 text-center">Resolution rate by personnel</div>
            </div>

            <div class="lg:col-span-2">
                <div id="engineerCards" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>

        <div class="space-y-6">
             <div class="flex justify-between items-center">
                <h3 id="tableTitle" class="text-xl font-bold text-white border-l-4 border-indigo-500 pl-4">Activity Log</h3>
                <div class="text-sm text-zinc-500" id="recordCount"></div>
            </div>
            <div class="bg-executive-900 border border-white/5 rounded-xl overflow-hidden shadow-2xl">
                <div class="overflow-x-auto">
                    <div id="tableContent"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-t border-white/5 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-6 text-center text-zinc-600 text-sm">
            <p>&copy; 2024 IT Operations Dashboard. Internal Use Only.</p>
        </div>
    </footer>

    <script>
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz1jIz73VKcat6GmkqovmqtXHyago4bimxxeaVWekniYU_lowq-e4t9FV1r2PSUqziIKw/exec', 
            API_KEY: '98415623-a1d1-4045-84d3-c3e67fa687af',
            REFRESH_INTERVAL: 300000,
            ENABLE_DEMO: false, 
            ORG_NAME: 'Your Organization'
        };

        const DEMO_DATA_TRACKER = [
            { 'Task': 'API Integration', 'Sub-Task': 'User Auth', 'Engineer': 'Alice Johnson', 'Status': 'Completed', 'Start Date': '2024-10-01', 'Closure Date': '2024-10-15', 'Blocker/Dependency': '' },
            { 'Task': 'API Integration', 'Sub-Task': 'Payment', 'Engineer': 'Bob Smith', 'Status': 'In Progress', 'Start Date': '2024-10-10', 'Closure Date': '', 'Blocker/Dependency': '' },
            { 'Task': 'Database Migration', 'Sub-Task': 'Schema', 'Engineer': 'Carol Davis', 'Status': 'Completed', 'Start Date': '2024-09-15', 'Closure Date': '2024-09-30', 'Blocker/Dependency': '' },
            { 'Task': 'Database Migration', 'Sub-Task': 'Data Transfer', 'Engineer': 'David Lee', 'Status': 'Blocked', 'Start Date': '2024-10-01', 'Closure Date': '', 'Blocker/Dependency': 'Waiting for approval' },
            { 'Task': 'Frontend Redesign', 'Sub-Task': 'Homepage', 'Engineer': 'Emma Wilson', 'Status': 'Completed', 'Start Date': '2024-11-01', 'Closure Date': '2024-11-10', 'Blocker/Dependency': '' },
            { 'Task': 'Frontend Redesign', 'Sub-Task': 'Dashboard', 'Engineer': 'Frank Brown', 'Status': 'In Progress', 'Start Date': '2024-11-05', 'Closure Date': '', 'Blocker/Dependency': '' }
        ];
        
        // Added some resolved items with realistic dates for calculation testing
        const DEMO_DATA_FRESHSERVICE = [
            { 'ID': 1001, 'Type': 'Incident', 'Status': 'Resolved', 'Priority': 'High', 'Subject': 'Network outage', 'Agent Name': 'Alice Johnson', 'Created Date': '2024-11-20 10:00', 'Resolved Date': '2024-11-20 14:30', 'Closed Date': '2024-11-21' },
            { 'ID': 1002, 'Type': 'Service Request', 'Status': 'Open', 'Priority': 'Low', 'Subject': 'Laptop Request', 'Agent Name': 'Carol Davis', 'Created Date': '2024-11-27 09:00', 'Resolved Date': '', 'Closed Date': '' },
            { 'ID': 1003, 'Type': 'Incident', 'Status': 'Resolved', 'Priority': 'Medium', 'Subject': 'Printer Issue', 'Agent Name': 'Bob Smith', 'Created Date': '2024-11-25 17:00', 'Resolved Date': '2024-11-26 11:00', 'Closed Date': '' }, 
            { 'ID': 1004, 'Type': 'Service Request', 'Status': 'Closed', 'Priority': 'High', 'Subject': 'Software Install', 'Agent Name': 'Alice Johnson', 'Created Date': '2024-11-15 11:00', 'Resolved Date': '2024-11-16 12:00', 'Closed Date': '2024-11-16' },
            { 'ID': 1005, 'Type': 'Problem', 'Status': 'On Hold', 'Priority': 'Medium', 'Subject': 'Server License', 'Agent Name': 'David Lee', 'Created Date': '2024-10-10', 'Resolved Date': '', 'Closed Date': '' },
            { 'ID': 1006, 'Type': 'Incident', 'Status': 'Open', 'Priority': 'High', 'Subject': 'Website Error', 'Agent Name': 'David Lee', 'Created Date': '2024-11-28', 'Resolved Date': '', 'Closed Date': '' },
        ];

        class Dashboard {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.metadata = { engineers: [], statuses: [] };
                this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                this.currentSource = 'tracker'; 
                this.chartInstance = null;
                this.init();
            }

            async init() {
                await this.switchDataSource(this.currentSource, false); 
                this.render();
                setInterval(() => this.loadData(), CONFIG.REFRESH_INTERVAL);
            }

            getFieldValue(item, fieldType) {
                if (!item) return '';
                if (fieldType === 'engineer') return item['Engineer'] || item['engineer'] || item['Agent Name'] || item['agent_name'] || item['agent'] || item['Responder'] || 'Unassigned';
                if (fieldType === 'date') return item['Start Date'] || item['start_date'] || item['Created Date'] || item['created_at'] || '';
                return '';
            }

            async switchDataSource(source, reload = true) {
                this.currentSource = source;
                const activeClass = "bg-executive-gold text-executive-950 font-bold shadow-lg";
                const inactiveClass = "text-zinc-400 hover:text-white";
                document.getElementById('trackerToggle').className = "px-6 py-2 rounded-md text-sm transition-all duration-300 " + (source === 'tracker' ? activeClass : inactiveClass);
                document.getElementById('freshserviceToggle').className = "px-6 py-2 rounded-md text-sm transition-all duration-300 " + (source === 'freshservice' ? activeClass : inactiveClass);
                document.getElementById('tableTitle').textContent = source === 'tracker' ? 'Engineering Tasks' : 'Helpdesk Tickets';
                document.getElementById('engineerFilterLabel').textContent = source === 'tracker' ? 'ENGINEERS' : 'AGENTS';
                if (reload) {
                    this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    await this.loadData();
                }
            }

            async loadData() {
                const refreshIcon = document.getElementById('refreshIcon');
                if(refreshIcon) refreshIcon.classList.add('animate-spin');
                try {
                    if (CONFIG.ENABLE_DEMO) {
                        await new Promise(r => setTimeout(r, 600)); 
                        this.data = this.currentSource === 'tracker' ? DEMO_DATA_TRACKER : DEMO_DATA_FRESHSERVICE;
                    } else {
                         if (!CONFIG.APPS_SCRIPT_URL || !CONFIG.API_KEY) throw new Error('Missing CONFIG');
                        const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getData&source=${this.currentSource}&key=${CONFIG.API_KEY}`);
                        const result = await response.json();
                        if (!result.success) throw new Error(result.message);
                        this.data = result.data;
                    }
                    const distinctEngineers = [...new Set(this.data.map(item => this.getFieldValue(item, 'engineer')))].filter(n => n && n !== 'Unassigned').sort();
                    const distinctStatuses = [...new Set(this.data.map(item => item.Status))].filter(Boolean).sort();
                    this.metadata = { engineers: distinctEngineers, statuses: distinctStatuses };
                    this.applyFilters();
                    this.render();
                    document.getElementById('lastUpdate').textContent = 'Synced: ' + new Date().toLocaleTimeString();
                } catch (error) { console.error(error); alert('Error: ' + error.message); } 
                finally { if(refreshIcon) refreshIcon.classList.remove('animate-spin'); }
            }

            applyFilters() {
                let filtered = [...this.data];
                if (this.filters.engineers.length > 0) filtered = filtered.filter(item => this.filters.engineers.includes(this.getFieldValue(item, 'engineer')));
                if (this.filters.statuses.length > 0) filtered = filtered.filter(item => this.filters.statuses.includes(item.Status));
                if (this.filters.dateRange.start && this.filters.dateRange.end) {
                    const start = new Date(this.filters.dateRange.start);
                    const end = new Date(this.filters.dateRange.end);
                    filtered = filtered.filter(item => {
                        const dateStr = this.getFieldValue(item, 'date');
                        return dateStr && new Date(dateStr) >= start && new Date(dateStr) <= end; 
                    });
                }
                this.filteredData = filtered;
            }

            toggleEngineerFilter(engineer) {
                const idx = this.filters.engineers.indexOf(engineer);
                if (idx > -1) this.filters.engineers.splice(idx, 1); else this.filters.engineers.push(engineer);
                this.applyFilters(); this.render();
            }
            toggleStatusFilter(status) {
                const idx = this.filters.statuses.indexOf(status);
                if (idx > -1) this.filters.statuses.splice(idx, 1); else this.filters.statuses.push(status);
                this.applyFilters(); this.render();
            }
            clearAllFilters() {
                this.filters = { engineers: [], statuses: [], dateRange: { start: '', end: '' } };
                document.getElementById('startDate').value = ''; document.getElementById('endDate').value = '';
                this.applyFilters(); this.render();
            }

            getMetrics() {
                const completedStatuses = this.currentSource === 'freshservice' ? ['Resolved', 'Closed'] : ['Completed'];
                const inProgressStatuses = this.currentSource === 'freshservice' ? ['Open', 'Pending', 'On Hold'] : ['In Progress', 'Not Started'];
                const highPriorityOpenStatuses = this.currentSource === 'freshservice' ? this.filteredData.filter(d => d.Status === 'Open' && d.Priority === 'High') : [];
                const completed = this.filteredData.filter(d => completedStatuses.includes(d.Status)).length;
                const inProgress = this.filteredData.filter(d => inProgressStatuses.includes(d.Status)).length;
                const blocked = this.currentSource === 'tracker' ? this.filteredData.filter(d => d.Status === 'Blocked').length : highPriorityOpenStatuses.length;
                return { total: this.filteredData.length, completed, inProgress, blocked };
            }

            // --- BUSINESS LOGIC FOR TIME CALCULATION ---
            getWorkingMinutes(startDate, endDate) {
                let minutes = 0;
                let current = new Date(startDate);
                const end = new Date(endDate);

                // Start/End Hours IST (10 AM to 6 PM)
                const START_HOUR = 10;
                const END_HOUR = 18;

                while (current < end) {
                    const day = current.getDay();
                    // 0 = Sunday, 6 = Saturday. Skip weekends.
                    if (day !== 0 && day !== 6) {
                        const currentHour = current.getHours();
                        // Only count if within 10 AM - 6 PM
                        if (currentHour >= START_HOUR && currentHour < END_HOUR) {
                            minutes++;
                        }
                    }
                    current.setMinutes(current.getMinutes() + 1);
                }
                return minutes;
            }

            getResolutionMetrics() {
                let totalMinutes = 0;
                let count = 0;
                let earliestDate = null;
                let latestDate = null;

                this.filteredData.forEach(item => {
                    // Check if ticket is resolved/closed and has both dates
                    if (['Resolved', 'Closed'].includes(item.Status) && item['Created Date'] && item['Resolved Date']) {
                        const start = new Date(item['Created Date']);
                        const end = new Date(item['Resolved Date']);
                        
                        if (!isNaN(start) && !isNaN(end) && end > start) {
                            // Track Period Range
                            if (!earliestDate || start < earliestDate) earliestDate = start;
                            if (!latestDate || start > latestDate) latestDate = start;

                            // Calculate Duration
                            totalMinutes += this.getWorkingMinutes(start, end);
                            count++;
                        }
                    }
                });

                const avgMinutes = count > 0 ? Math.floor(totalMinutes / count) : 0;
                const hours = Math.floor(avgMinutes / 60);
                const mins = avgMinutes % 60;
                
                // Format Period String
                const formatDate = (d) => d ? d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '-';
                const periodString = earliestDate && latestDate ? `${formatDate(earliestDate)} - ${formatDate(latestDate)}` : 'No Data';

                return {
                    avgTime: count > 0 ? `${hours}h ${mins}m` : 'N/A',
                    period: periodString,
                    ticketCount: count
                };
            }
            // -------------------------------------------

            getEngineerStats() {
                const stats = {};
                const completedStatuses = this.currentSource === 'freshservice' ? ['Resolved', 'Closed'] : ['Completed'];
                this.filteredData.forEach(item => {
                    const name = this.getFieldValue(item, 'engineer');
                    if (!name || name === 'Unassigned') return;
                    if (!stats[name]) stats[name] = { total: 0, completed: 0 };
                    stats[name].total++;
                    if (completedStatuses.includes(item.Status)) stats[name].completed++;
                });
                return Object.entries(stats).map(([name, data]) => ({
                    name, ...data, rate: data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0
                })).sort((a, b) => b.rate - a.rate);
            }

            render() {
                this.renderFilters();
                this.renderStats();
                this.renderEngineerSection();
                this.renderTable();
                if (window.lucide) window.lucide.createIcons();
                document.getElementById('recordCount').innerText = `${this.filteredData.length} records found`;
            }

            renderFilters() {
                const engContainer = document.getElementById('engineerFilters');
                const statContainer = document.getElementById('statusFilters');
                if(!engContainer || !statContainer) return;
                const engineerList = this.metadata.engineers || [];
                engContainer.innerHTML = engineerList.length === 0 ? '<span class="text-zinc-600 text-xs italic">No agents found</span>' : 
                    engineerList.map(eng => `<button class="px-3 py-1 text-xs font-medium rounded-full border transition-all duration-200 ${this.filters.engineers.includes(eng) ? 'bg-executive-gold text-executive-950 border-executive-gold' : 'bg-executive-900 text-zinc-400 border-white/5 hover:border-white/20 hover:text-white'}" onclick="dashboard.toggleEngineerFilter('${eng}')">${eng}</button>`).join('');
                statContainer.innerHTML = (this.metadata.statuses || []).map(status => `<button class="px-3 py-1 text-xs font-medium rounded-full border transition-all duration-200 ${this.filters.statuses.includes(status) ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-executive-900 text-zinc-400 border-white/5 hover:border-white/20 hover:text-white'}" onclick="dashboard.toggleStatusFilter('${status}')">${status}</button>`).join('');
            }

            renderStats() {
                const metrics = this.getMetrics();
                const createCard = (label, value, iconName, colorText, bgSub) => `
                    <div class="bg-executive-900 border border-white/5 rounded-xl p-6 shadow-lg hover:border-white/10 transition-all duration-300 group">
                        <div class="flex justify-between items-start">
                            <div><p class="text-zinc-500 text-xs font-semibold uppercase tracking-wider mb-1">${label}</p><h3 class="text-3xl font-bold ${colorText}">${value}</h3></div>
                            <div class="p-3 rounded-lg bg-white/5 ${bgSub} group-hover:bg-white/10 transition-colors"><i data-lucide="${iconName}" class="w-6 h-6"></i></div>
                        </div>
                    </div>`;

                let html = `
                    ${createCard('Total Items', metrics.total, 'trending-up', 'text-white', 'text-zinc-400')}
                    ${createCard(this.currentSource === 'tracker' ? 'Completed' : 'Resolved', metrics.completed, 'check-circle', 'text-emerald-400', 'text-emerald-400/80')}
                    ${createCard(this.currentSource === 'tracker' ? 'In Progress' : 'Open/Pending', metrics.inProgress, 'clock', 'text-indigo-400', 'text-indigo-400/80')}
                `;

                // CONDITIONAL RENDERING FOR 4th CARD
                if (this.currentSource === 'freshservice') {
                    // Calculate Resolution Time
                    const resMetrics = this.getResolutionMetrics();
                    html += `
                        <div class="bg-executive-900 border border-violet-500/30 rounded-xl p-6 shadow-lg glow-card group relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-8 opacity-20"><div class="w-20 h-20 rounded-full bg-violet-600 blur-2xl"></div></div>
                            <div class="flex justify-between items-start relative z-10">
                                <div>
                                    <p class="text-violet-300 text-xs font-semibold uppercase tracking-wider mb-1">Avg Resolution Time</p>
                                    <h3 class="text-3xl font-bold text-violet-400">${resMetrics.avgTime}</h3>
                                    <div class="mt-2 inline-flex items-center gap-1 px-2 py-0.5 rounded bg-violet-500/10 border border-violet-500/20 text-[10px] text-violet-300">
                                        <i data-lucide="calendar" class="w-3 h-3"></i> ${resMetrics.period}
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-violet-500/20 text-violet-300 group-hover:bg-violet-500/30 transition-colors">
                                    <i data-lucide="zap" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += createCard('Blocked', metrics.blocked, 'alert-circle', 'text-red-400', 'text-red-400/80');
                }

                document.getElementById('statsGrid').innerHTML = html;
            }

            renderEngineerSection() {
                const engineers = this.getEngineerStats();
                const container = document.getElementById('engineerCards');
                if (container) {
                    container.innerHTML = engineers.map(eng => `
                        <div class="bg-executive-900 border border-white/5 rounded-xl p-5 hover:border-executive-gold/30 transition-all duration-200 group relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-executive-gold to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div class="flex justify-between items-start mb-4">
                                <div><h4 class="font-bold text-gray-200 text-lg">${eng.name}</h4><p class="text-zinc-500 text-sm">${eng.completed} / ${eng.total} Items</p></div>
                                <div class="text-2xl font-black text-executive-gold">${eng.rate}%</div>
                            </div>
                            <div class="w-full bg-zinc-800 rounded-full h-2 overflow-hidden"><div class="h-full bg-gradient-to-r from-indigo-500 to-executive-gold transition-all duration-500" style="width: ${eng.rate}%"></div></div>
                        </div>`).join('') || '<div class="col-span-2 text-center text-zinc-500 py-10 italic">No performance data available.</div>';
                }
                this.updateChart(engineers);
            }

            updateChart(engineers) {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) return;
                const topEng = engineers.slice(0, 10);
                const colors = topEng.map(e => e.rate >= 80 ? '#10b981' : e.rate >= 50 ? '#6366f1' : '#f59e0b');
                if (this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: topEng.map(e => e.name), datasets: [{ label: 'Rate %', data: topEng.map(e => e.rate), backgroundColor: colors, borderRadius: 4, barThickness: 12 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#18181b', bodyColor: '#fff' } }, scales: { x: { display: false, max: 100 }, y: { ticks: { color: '#a1a1aa' }, grid: { display: false } } } }
                });
            }

            exportCSV() {
                 let headers, rows;
                if (this.currentSource === 'freshservice') {
                    headers = ['ID', 'Type', 'Status', 'Priority', 'Subject', 'Agent Name', 'Created Date', 'Resolved Date'];
                    rows = this.filteredData.map(item => [item.ID, item.Type, item.Status, item.Priority, item.Subject, this.getFieldValue(item, 'engineer'), item['Created Date'], item['Resolved Date']]);
                } else { 
                    headers = ['Task', 'Sub-Task', 'Engineer', 'Status', 'Start Date', 'Closure Date', 'Blocker'];
                    rows = this.filteredData.map(item => [item.Task, item['Sub-Task'], this.getFieldValue(item, 'engineer'), item.Status, item['Start Date'], item['Closure Date'], item['Blocker/Dependency']]);
                }
                const csv = [headers, ...rows].map(row => (row || []).map(cell => `"${cell || ''}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `report.csv`;
                link.click();
            }

            renderTable() {
                if (this.filteredData.length === 0) {
                    document.getElementById('tableContent').innerHTML = `<div class="p-12 text-center"><div class="text-4xl mb-4 text-zinc-600">ðŸ“­</div><h3 class="text-white font-medium mb-1">No Records Found</h3></div>`;
                    return;
                }
                const getBadge = (s) => {
                    s = s.toLowerCase();
                    let c = 'bg-zinc-800 text-zinc-300';
                    if (s.match(/completed|resolved|closed/)) c = 'bg-emerald-900/30 text-emerald-400';
                    else if (s.match(/open|progress|pending/)) c = 'bg-indigo-900/30 text-indigo-400';
                    else if (s.match(/blocked|high/)) c = 'bg-red-900/30 text-red-400';
                    return `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border border-transparent ${c}">${s}</span>`;
                };
                let th, tr;
                if (this.currentSource === 'freshservice') {
                    th = `<th>ID / Subject</th><th>Agent</th><th>Status</th><th>Created</th>`;
                    tr = this.filteredData.map(i => `<tr class="border-b border-white/5 hover:bg-white/5"><td class="px-6 py-4"><div class="text-sm font-bold text-white">#${i.ID||'?'}</div><div class="text-xs text-zinc-500">${i.Subject||'-'}</div></td><td class="px-6 py-4 text-sm text-zinc-300">${this.getFieldValue(i,'engineer')}</td><td class="px-6 py-4">${getBadge(i.Status)}</td><td class="px-6 py-4 text-xs text-zinc-500 font-mono">${i['Created Date']||'-'}</td></tr>`).join('');
                } else {
                    th = `<th>Task</th><th>Engineer</th><th>Status</th><th>Timeline</th>`;
                    tr = this.filteredData.map(i => `<tr class="border-b border-white/5 hover:bg-white/5"><td class="px-6 py-4"><div class="text-sm font-bold text-white">${i.Task}</div><div class="text-xs text-zinc-500">${i['Sub-Task']||''}</div></td><td class="px-6 py-4 text-sm text-zinc-300">${this.getFieldValue(i,'engineer')}</td><td class="px-6 py-4">${getBadge(i.Status)}</td><td class="px-6 py-4 text-xs text-zinc-500 font-mono">${i['Start Date']}</td></tr>`).join('');
                }
                document.getElementById('tableContent').innerHTML = `<table class="w-full text-left"><thead class="bg-executive-950 border-b border-white/10"><tr>${th.replace(/th>/g,'th class="px-6 py-4 text-xs font-semibold text-zinc-500 uppercase">')}</tr></thead><tbody class="divide-y divide-white/5">${tr}</tbody></table>`;
            }
        }

        let dashboard;
        window.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
            document.getElementById('refreshBtn').addEventListener('click', () => dashboard.loadData());
            document.getElementById('exportBtn').addEventListener('click', () => dashboard.exportCSV());
            const dateHandler = () => { dashboard.filters.dateRange.start = document.getElementById('startDate').value; dashboard.filters.dateRange.end = document.getElementById('endDate').value; dashboard.applyFilters(); dashboard.render(); };
            document.getElementById('startDate').addEventListener('change', dateHandler);
            document.getElementById('endDate').addEventListener('change', dateHandler);
        });
    </script>
</body>
</html>
